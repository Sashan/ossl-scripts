<!DOCTYPE html>

<html>

<head>
<style>
    .code { font-family: monospace }
    .leak-trace-full { display: none }
    .mem-trace { display: none }
    #chart { float: none }
    #mem-traces { float: right; padding-left: 80px; width: 300px }
    #summary { float: none}
</style>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    var selected_stack = null;

    function toggle(element_id)
    {
	var trace = document.querySelector("#" + element_id);
	if (trace.style.display == 'none') {
	    trace.style.display = 'block';
	} else {
	    trace.style.display = 'none';
	}
    }

    function select_stack(event, chartContext, opts)
    {
	var stack = document.querySelector("#" + "mem-trace-" + opts.dataPointIndex);
        if (stack) {
	    if (selected_stack != null)
                selected_stack.style.display = 'none'
            stack.style.display = 'block'
	    selected_stack = stack;
        }
    }

    document.addEventListener("DOMContentLoaded", function(){
	var chart_opts = {
	    chart: { 
		height: 450,
		width: 900,
		type: 'line',
		events: {
		    dataPointSelection: select_stack
		}
	    },
	    series: [{
		name: 'Memory Profile',
		data: [ {%- for i in mp.get_profile() -%} {{ i }} {%- if not loop.last -%}, {%- endif -%} {%- endfor -%} ]
	    }],
	    xaxis: {
		categories: [ {%- for i in mp.get_time_axis() -%} {{ i }} {%- if not loop.last -%}, {%- endif -%} {%- endfor -%} ],
		title: {
		    text: 'Elapsed time in uSecs'
		}
	    },
	    tooltip: {
		intersect: true,
		shared: false
	    },
	    markers: {
		size: 3
	    }
	}

	var chart = new ApexCharts(document.querySelector("#chart"), chart_opts);
	chart.render();
    });
</script>
<title> {{ title }} </title>
</head>

<body>
    <h1>{{ title }}</h1>
    <div id="top">
	<div id="mem-traces">
	    <div class="mem-trace" id="mem-trace-0"></div><!--- fake record at time 0 --->
	    {% for st in mp.get_stacks() %}
	    <div class="mem-trace" id="mem-trace-{{ loop.index }}">
		<ul>{% for frame in mp.get_frames(st) %}
		    <li><div class="code">{{ frame }}</div></li>
		{% endfor %}
		</ul>
	    </div>
	    {% endfor %}
	</div>
	<div id="chart"></div>
    </div>

    <div id="summary">
	<p>
	    {{ mp.get_total_mem() }} bytes of memory allocated in {{ mp.get_total_allocs() }} operations.
	</p>
	{% for leak in mp.leaks() %}
	<div id="leaks">
	    {% if loop.first %}
	    <h1>{%- if leak_count == 1 -%} Leak found {%- else -%} {{ leak_count }} Leasks found {%- endif -%}, {{ lost_bytes }} B  got lost </h1>
            {% endif %}
		<h2>Leak {{ loop.index }} is {{ mp.get_leak_sz(leak) }} bytes long. </h2>
		<ul>{% for op in mp.get_chain(leak) %}
		    <li class="leak-trace-button" id="leak-{{ leak.id }}-{{ op.id }}" onclick="toggle('show-leak-{{ leak.id }}-{{ op.id }}')">
			<div class="leak-trace" id="ref-leak-{{ leak.id }}-{{ op.id }}">
			    <div class="code">{{ MR(op).get_operation() }}({{ MR(op).get_rsize() }}) at {{ mp.get_time(op) }}</div>
			</div>
			<div class="leak-trace-full" id="show-leak-{{ leak.id }}-{{ op.id }}">
			    <ul>{% for frame in mp.get_stack(op) %}
				<li><div class="code">{{ frame }}</div></li>
				{% endfor %}
			    </ul>
			</div>
			{% endfor %}
		    </li>
		</ul>
	</div><!--- "leaks" --->
	{% endfor %}
    </div><!--- "summary" --->
</body>
</html>
